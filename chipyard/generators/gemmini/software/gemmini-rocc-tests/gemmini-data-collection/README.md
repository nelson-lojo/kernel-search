# Gemmini Data Collection

This directory contains scripts that enable large-scale, seamless data collection for various test benches applied on various configurations of Gemmini.
These scripts generally work by automatically generating _new_ C source files in the `bareMetalC/` directory, and running them in parallel for rapid data collection.

Most of the following documentation assumes the current working directory is `gemmini/software/gemmini-rocc-tests/gemmini-data-collection`.

## How to Use

### Step 1: Create Test Bench Template

* Make a generalized version of the test bench you want to simulate on Gemmini in the `templates` folder.

* For all values of the test bench you want to make variable, replace each usage of each value with its respective `%<KEYWORD_NAME>%`.

* If you just want to run matrix multiplications or convolutions, then you can skip this step as we already provide templates for these operations.

### Step 2: Specify Tests to Run

* Open `tests.py` in your preferred text editor, and make `GemminiTest` objects for each test you want to simulate (e.g. one test for a 512-by-512-by-512 matmul, or another test for a small convolution). You may refer to the existing examples in `tests.py`.

* The `GemminiTest` objects should have the following arguments:
    * **Parameter 1**: an array of keywords used in the template
    * **Parameter 2**: an array of values to replace the keywords specified in Parameter 1 (in respective order)
    * **Parameter 3**: name of template you are using (must be a `C` file located in the `templates` folder)
    * **Parameter 4**: name of output file (`C` file) you want generated in `bareMetalC` folder

### Step 3: Construct Gemmini Configurations

* This step is optional and is only necessary if you wish to collect simulation data for hardware configurations different than the Gemmini defaults (e.g. with different spatial array dimensions, or scratchpad sizes).

* Go to `gemmini/src/main/scala/gemmini/CustomConfigs.scala` and create your desired Gemmini configs

* Keep note of their names â€“ you will need them for Step 4

### Step 4: Run Tests in Parallel

* Refer to descriptions of `gen_data.sh` and `config_gen_data.sh` in the section below.

* Run the `config_gen_data.sh` script from the `gemmini-data-collection` directory, as our paths assume that this is your current working directory.
   - Note that all the tests you specificed in Step 2 will run **in parallel** on separate processes. Make sure you are running on a server with sufficient RAM for all those tests!

## Detailed Script Descriptions
### `gemmini_data_collection.py`

This script generates three other critical scripts that facilitate the data collection process, described below.

Each call to the `main` function of this script generates an instance of a template test bench (ex. GEMM, 2D-Conv) for Gemmini simulation; it also mutates the below scripts to account for the instance:

* `gemmini/data-collection-vcs.sh`
    
    * Uses the `gemmini/scripts/run-vcs.sh` script to run a faster cycle-accurate Gemmini simulation for each instance generated by the `gemmini_data_collection.py` script
    
    * Output containing the cycle count directed to `gemmini/data-collection-output`.

* `gemmini/data-collection-midas.sh midas_dram_model`
    
    * Uses the `gemmini/scripts/run-midas.sh` script to run a cycle-accurate Gemmini simulation with a more precise DRAM model for each instance generated by the `gemmini_data_collection.py` script

    * Output containing the cycle count is directed to `gemmini/data-collection-output`.

* `gemmini/data-collection-spike.sh`
    
    * Uses the `gemmini/scripts/run-spike.sh` script to run through the "functionality" of each instance generated by the `gemmini_data_collection.py` script
    
    * When Spike is called, a switch will enable the tiling factors for the job to be outputted instead of the cycle count (does not happen when running `gemmini/data-collection-vcs.sh` or `gemmini/data-collection-midas.sh`)
    
    * Output containing tiling factors directed to `gemmini/data-collection-output`

* `clean.sh`
    
    * Cleans the output of `gemmini/software/gemmini-rocc-tests/build.sh` script
    
    * Deletes `gemmini/data-collection-output-configs` folder
    
    * Deletes `gemmini/data-collection-output` folder
    
    * Deletes `gemmini/data-collection-vcs.sh` script

    * Deletes `gemmini/data-collection-midas.sh` script
    
    * Deletes `gemmini/data-collection-spike.sh` script
    
    * Deletes all test bench instance `C` files generated from the `gemmini_data_collection.py` script
    
    * Resets `Makefile` to remove instruction to build test bench instances

### `gen_data.sh tile|cycle vcs|verilator|midas [midas_dram_model]`

* If called with the `tile` parameter, script generates output with tiling factors; if called with the `cycle` parameter, script generates output with simulation cycles

* Cleans all prior output via `clean.sh`

* Runs `gemmini_data_collection.py`

* If called with the `tile` parameter, turns switch to print tiling factors on; if called with the `cycle` parameter, turns switch to print tiling factors off (affects `gemmini/software/gemmini-rocc-tests/include/gemmini.h`), and instead prints the cycle count.

* Builds the `bareMetalC` tests

* If called with the `tile` parameter, calls `gemmini/data-collection-spike.sh`

* If called with the `cycle` parameter, then a second input parameter is expected (`vcs`, `verilator`, or `midas` to specify which simulation)

    * If called with the `vcs` parameter, calls `gemmini/data-collection-vcs.sh`

    * If called with the `midas` parameter, calls `gemmini/data-collection-midas.sh`

* **Note:** The `midas_dram_model` parameter is only required if the script is called with the `midas` argument

### `config_gen_data.sh config_name vcs|verilator|midas [midas_dram_model]`

* Sets the active Gemmini configuration in `gemmini/src/main/scala/gemmini/CustomConfigs.scala` to the specified `config_name` Scala variable name provided as a parameter

    * If you want to use the default configuration, you should pass in `baselineInferenceConfig` as the first parameter

* Builds Spike and _either_ VCS, _or_ Verilator, _or_ Midas based on the chosen configuration using `gemmini/scripts/build-spike.sh` and _either_ `gemmini/scripts/build-vcs.sh`, _or_ `gemmini/scripts/build-verilator.sh`, _or_ `gemmini/scripts/build-midas.sh` respectively.

* Runs `gen_data.sh tile` and `gen_data.sh cycle [vcs|verilator|midas]` to collect both tiling factor data and simulation cycle count data.

* Places output in subfolders within the `data-collection-output-configs` folder; the subfolders follow the naming format `data-collection-output-<spike/vcs/verilator/midas>-<config_name>` where the `<>` indicates variability of naming

* **Note:** The `midas_dram_model` parameter is only required if the script is called with the `midas` argument

